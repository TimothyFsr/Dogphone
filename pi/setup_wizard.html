<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DogPhone Setup</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      padding: 24px;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      line-height: 1.5;
    }
    .container { max-width: 420px; margin: 0 auto; }
    h1 {
      font-size: 1.75rem;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sub { color: #888; margin-bottom: 24px; font-size: 0.95rem; }
    .step {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .step h2 { margin: 0 0 8px; font-size: 1.1rem; }
    .step p { margin: 0 0 12px; color: #bbb; font-size: 0.9rem; }
    #qrcode {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      display: inline-block;
      margin: 12px 0;
    }
    #qrcode canvas, #qrcode img { display: block; }
    .url-box {
      background: #0f0f1a;
      padding: 10px 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.85rem;
      word-break: break-all;
      margin: 8px 0;
    }
    .url-box a { color: #7dd3fc; }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0f0f1a;
      color: #eee;
      font-size: 1rem;
      margin-bottom: 12px;
    }
    input::placeholder { color: #666; }
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #e879f9;
      color: #1a1a2e;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    button.secondary { background: #334155; color: #e2e8f0; }
    .done-msg {
      background: #14532d;
      color: #86efac;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-weight: 500;
    }
    .error-msg { color: #f87171; font-size: 0.9rem; margin-top: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üêï DogPhone</h1>
    <p class="sub">Set up in a few steps</p>
    <p style="margin-bottom:16px;"><a href="/exit" style="color:#94a3b8; font-size:0.9rem;">Close DogPhone (exit full screen)</a></p>

    <!-- Step 0: On-screen instructions (for the Pi display) -->
    <div class="step" id="step-scan">
      <h2>1. Open setup on your phone</h2>
      <p>Connect your phone to WiFi <strong>DogPhone-Setup</strong>. Password: <strong>dogphone123</strong>. Then open <strong>http://10.42.0.1:8765</strong> in your browser (if it doesn‚Äôt load, try http://192.168.4.1:8765).</p>
      <p>Then <strong>scan this QR code</strong> with your camera to open the setup page:</p>
      <div id="qrcode"></div>
      <p>Or open one of these in your browser (try the first; if it doesn‚Äôt load, try the second):</p>
      <div class="url-box" id="setup-url"></div>
      <div class="url-box url-box-alt" id="setup-url-alt" style="margin-top:8px;"></div>
    </div>

    <!-- Steps shown when opened on phone -->
    <div class="step" id="step-telegram">
      <h2>2. Connect Telegram</h2>
      <p>Create a bot in Telegram: open <strong>@BotFather</strong>, send <code>/newbot</code>, follow the steps, then copy the <strong>bot token</strong> here.</p>
      <input type="text" id="token" placeholder="Paste your bot token" autocomplete="off">
      <button type="button" id="btn-token">Save token</button>
      <p class="error-msg hidden" id="err-token"></p>
    </div>

    <div class="step hidden" id="step-message">
      <h2>3. Get your Chat ID</h2>
      <p>In Telegram, open a chat with your new bot and send any message (e.g. <strong>hi</strong>). Then tap below to detect it.</p>
      <button type="button" id="btn-detect">I sent a message ‚Äì detect me</button>
      <p class="error-msg hidden" id="err-detect"></p>
      <p style="margin-top:16px; color:#94a3b8; font-size:0.9rem;">If detection doesn‚Äôt work (e.g. no internet on the device), get your Chat ID manually: in Telegram, open <strong>@userinfobot</strong> and send it any message ‚Äì it will reply with your ID (a number). Paste that number below:</p>
      <input type="text" id="chat-id-manual" placeholder="Or paste your Chat ID (e.g. 123456789)" inputmode="numeric" pattern="[0-9\-]+" style="margin-top:8px;">
      <button type="button" id="btn-manual-chat" class="secondary" style="margin-top:8px;">Use this Chat ID and finish</button>
    </div>

    <div class="step hidden" id="step-done">
      <h2>4. All set!</h2>
      <p>Setup is complete. The device will restart and your dog can start calling you.</p>
      <div class="done-msg hidden" id="done-msg">Restarting in a few seconds‚Ä¶</div>
    </div>

    <div class="step" style="margin-top:24px;">
      <h2>Update</h2>
      <p>Get the latest version from <a href="https://github.com/TimothyFsr/Dogphone" target="_blank" rel="noopener">GitHub</a>. If this device was installed from git, you can update now.</p>
      <button type="button" id="btn-update" class="secondary">Check for updates</button>
      <p class="error-msg hidden" id="err-update"></p>
      <p class="done-msg hidden" id="msg-update"></p>
    </div>
  </div>

  <script>
    const API = '';
    const qrEl = document.getElementById('qrcode');
    const urlEl = document.getElementById('setup-url');
    const urlAltEl = document.getElementById('setup-url-alt');
    const stepScan = document.getElementById('step-scan');
    const stepTelegram = document.getElementById('step-telegram');
    const stepMessage = document.getElementById('step-message');
    const stepDone = document.getElementById('step-done');
    const tokenInput = document.getElementById('token');
    const btnToken = document.getElementById('btn-token');
    const btnDetect = document.getElementById('btn-detect');
    const errToken = document.getElementById('err-token');
    const errDetect = document.getElementById('err-detect');
    const doneMsg = document.getElementById('done-msg');
    const chatIdManualInput = document.getElementById('chat-id-manual');
    const btnManualChat = document.getElementById('btn-manual-chat');
    const btnUpdate = document.getElementById('btn-update');
    const errUpdate = document.getElementById('err-update');
    const msgUpdate = document.getElementById('msg-update');

    async function api(path, opts = {}) {
      const base = location.origin;
      const r = await fetch(base + path, { headers: { 'Content-Type': 'application/json' }, ...opts });
      return r.json();
    }

    async function loadStatus() {
      const s = await api('/api/status');
      const url = s.setup_url || (location.protocol + '//' + location.host);
      urlEl.innerHTML = '<a href="' + url + '">' + url + '</a>';
      if (s.alternate_urls && s.alternate_urls.length) {
        urlAltEl.innerHTML = s.alternate_urls.map(u => '<a href="' + u + '">' + u + '</a>').join(' &nbsp; ');
        urlAltEl.style.display = 'block';
      } else {
        urlAltEl.style.display = 'none';
      }
      if (typeof QRCode !== 'undefined') {
        QRCode.toCanvas(url, { width: 220, margin: 1 }, (err, canvas) => {
          if (!err && canvas) qrEl.appendChild(canvas);
        });
      }
      if (s.ready) {
        stepScan.classList.add('hidden');
        stepTelegram.classList.add('hidden');
        stepMessage.classList.add('hidden');
        stepDone.classList.remove('hidden');
        doneMsg.classList.remove('hidden');
        return;
      }
      if (s.has_token) {
        stepTelegram.classList.add('hidden');
        stepMessage.classList.remove('hidden');
      }
      return s;
    }

    btnToken.addEventListener('click', async () => {
      errToken.classList.add('hidden');
      const token = tokenInput.value.trim();
      if (!token) { errToken.textContent = 'Please paste your bot token.'; errToken.classList.remove('hidden'); return; }
      btnToken.disabled = true;
      try {
        const r = await api('/api/telegram', { method: 'POST', body: JSON.stringify({ token }) });
        if (r.ok) {
          stepTelegram.classList.add('hidden');
          stepMessage.classList.remove('hidden');
        } else { errToken.textContent = r.error || 'Failed'; errToken.classList.remove('hidden'); }
      } catch (e) {
        errToken.textContent = 'Network error. Are you on DogPhone-Setup WiFi?'; errToken.classList.remove('hidden');
      }
      btnToken.disabled = false;
    });

    btnDetect.addEventListener('click', async () => {
      errDetect.classList.add('hidden');
      btnDetect.disabled = true;
      btnDetect.textContent = 'Checking‚Ä¶';
      try {
        const r = await api('/api/chat_id');
        if (r.ok && r.chat_id) {
          stepMessage.classList.add('hidden');
          stepDone.classList.remove('hidden');
          doneMsg.classList.remove('hidden');
          setTimeout(() => api('/api/complete', { method: 'POST', body: JSON.stringify({ chat_id: r.chat_id }) }), 500);
        } else {
          if (r.error === 'network_error') {
            errDetect.textContent = 'Device can‚Äôt reach Telegram (no internet on hotspot). Use ‚ÄúOr paste your Chat ID‚Äù below.';
          } else if (r.error === 'no_updates') {
            errDetect.textContent = 'No message yet. Send a message to your bot in Telegram, then try again.';
          } else if (r.error === 'invalid_token') {
            errDetect.textContent = 'Invalid bot token. Check step 2 and save the token again.';
          } else {
            errDetect.textContent = 'Could not detect. Send a message to your bot, or enter your Chat ID below.';
          }
          errDetect.classList.remove('hidden');
        }
      } catch (e) {
        errDetect.textContent = 'Network error. Use ‚ÄúOr paste your Chat ID‚Äù below.';
        errDetect.classList.remove('hidden');
      }
      btnDetect.disabled = false;
      btnDetect.textContent = 'I sent a message ‚Äì detect me';
    });

    btnManualChat.addEventListener('click', async () => {
      const cid = (chatIdManualInput.value || '').trim().replace(/\s/g, '');
      if (!cid || !/^-?\d+$/.test(cid)) {
        errDetect.textContent = 'Enter a number (your Chat ID from @userinfobot).';
        errDetect.classList.remove('hidden');
        return;
      }
      errDetect.classList.add('hidden');
      btnManualChat.disabled = true;
      try {
        const r = await api('/api/complete', { method: 'POST', body: JSON.stringify({ chat_id: cid }) });
        if (r.ok) {
          stepMessage.classList.add('hidden');
          stepDone.classList.remove('hidden');
          doneMsg.classList.remove('hidden');
        } else {
          errDetect.textContent = 'Failed to save. Try again.';
          errDetect.classList.remove('hidden');
        }
      } catch (e) {
        errDetect.textContent = 'Network error.';
        errDetect.classList.remove('hidden');
      }
      btnManualChat.disabled = false;
    });

    btnUpdate.addEventListener('click', async () => {
      errUpdate.classList.add('hidden');
      msgUpdate.classList.add('hidden');
      btnUpdate.disabled = true;
      try {
        const r = await api('/api/update', { method: 'POST' });
        if (r.ok) {
          msgUpdate.textContent = r.message || 'Done. Restart the device to apply changes.';
          msgUpdate.classList.remove('hidden');
        } else {
          errUpdate.textContent = r.message || 'Update failed.';
          errUpdate.classList.remove('hidden');
        }
      } catch (e) {
        errUpdate.textContent = 'Network error.';
        errUpdate.classList.remove('hidden');
      }
      btnUpdate.disabled = false;
    });

    loadStatus();
  </script>
</body>
</html>
