<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DogPhone Setup</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      padding: 24px;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      line-height: 1.5;
    }
    .container { max-width: 420px; margin: 0 auto; }
    h1 {
      font-size: 1.75rem;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sub { color: #888; margin-bottom: 24px; font-size: 0.95rem; }
    .step {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .step h2 { margin: 0 0 8px; font-size: 1.1rem; }
    .step p { margin: 0 0 12px; color: #bbb; font-size: 0.9rem; }
    #qrcode {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      display: inline-block;
      margin: 12px 0;
    }
    #qrcode canvas, #qrcode img { display: block; }
    .url-box {
      background: #0f0f1a;
      padding: 10px 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.85rem;
      word-break: break-all;
      margin: 8px 0;
    }
    .url-box a { color: #7dd3fc; }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0f0f1a;
      color: #eee;
      font-size: 1rem;
      margin-bottom: 12px;
    }
    input::placeholder { color: #666; }
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #e879f9;
      color: #1a1a2e;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    button.secondary { background: #334155; color: #e2e8f0; }
    .done-msg {
      background: #14532d;
      color: #86efac;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-weight: 500;
    }
    .error-msg { color: #f87171; font-size: 0.9rem; margin-top: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üêï DogPhone</h1>
    <p class="sub">Set up in a few steps</p>
    <p style="margin-bottom:16px;"><a href="/exit" style="color:#94a3b8; font-size:0.9rem;">Close DogPhone (exit full screen)</a></p>

    <!-- Step 0: On-screen instructions (for the Pi display) -->
    <div class="step" id="step-scan">
      <h2>1. Open setup on your phone</h2>
      <p>Connect your phone to WiFi <strong>DogPhone-Setup</strong>. Password: <strong>dogphone123</strong>. Then <strong>scan this QR code</strong> with your camera to open the setup page (or open the URL below in your browser).</p>
      <div id="qrcode"></div>
      <p>Or open one of these in your browser (if the first doesn‚Äôt load, try the second):</p>
      <div class="url-box" id="setup-url"></div>
      <div class="url-box url-box-alt" id="setup-url-alt" style="margin-top:8px;"></div>
    </div>

    <!-- When on hotspot with no internet: connect Pi to user's WiFi first -->
    <div class="step hidden" id="step-wifi">
      <h2>1. Connect the Pi to your WiFi</h2>
      <p>Enter your home WiFi name and password. The Pi will reboot and try to connect. If it fails, you‚Äôll stay on this page ‚Äî try again.</p>
      <input type="text" id="wifi-ssid" placeholder="WiFi name (SSID)" autocomplete="off">
      <input type="password" id="wifi-password" placeholder="WiFi password">
      <button type="button" id="btn-wifi">Save and connect</button>
      <p class="error-msg hidden" id="err-wifi"></p>
      <p class="done-msg hidden" id="msg-wifi-reboot">Pi is rebooting. Switch your phone to your home WiFi, then open this page again (scan the QR code on the Pi screen or use the Pi‚Äôs IP from your router).</p>
    </div>

    <!-- Steps shown when Pi has internet (after WiFi connected) -->
    <div class="step hidden" id="step-telegram">
      <h2>2. Connect Telegram</h2>
      <p>Create a bot in Telegram: open <strong>@BotFather</strong>, send <code>/newbot</code>, follow the steps, then copy the <strong>bot token</strong> here.</p>
      <input type="text" id="token" placeholder="Paste your bot token" autocomplete="off">
      <button type="button" id="btn-token">Save token</button>
      <p class="error-msg hidden" id="err-token"></p>
    </div>

    <div class="step hidden" id="step-message">
      <h2>3. Get your Chat ID</h2>
      <p>In Telegram, open a chat with your new bot and send any message (e.g. <strong>hi</strong>). Then tap below to detect it.</p>
      <button type="button" id="btn-detect">I sent a message ‚Äì detect me</button>
      <p class="error-msg hidden" id="err-detect"></p>
      <p style="margin-top:16px; color:#94a3b8; font-size:0.9rem;">If detection doesn‚Äôt work (e.g. no internet on the device), get your Chat ID manually: in Telegram, open <strong>@userinfobot</strong> and send it any message ‚Äì it will reply with your ID (a number). Paste that number below:</p>
      <input type="text" id="chat-id-manual" placeholder="Or paste your Chat ID (e.g. 123456789)" inputmode="numeric" pattern="[0-9\-]+" style="margin-top:8px;">
      <button type="button" id="btn-manual-chat" class="secondary" style="margin-top:8px;">Use this Chat ID</button>
    </div>

    <div class="step hidden" id="step-zoom">
      <h2>4. Add your Zoom link</h2>
      <p>Sign up at <a href="https://zoom.us" target="_blank" rel="noopener">zoom.us</a> (free). In <strong>Profile ‚Üí Personal Meeting Room</strong> copy your <strong>Join URL</strong>. In Zoom settings enable <strong>‚ÄúJoin before host‚Äù</strong>. Paste the URL below.</p>
      <input type="text" id="video-url" placeholder="Meeting ID or URL (e.g. 123456789 or https://zoom.us/j/123456789)" autocomplete="off">
      <input type="text" id="video-password" placeholder="Meeting password (optional)" autocomplete="off">
      <button type="button" id="btn-zoom">Save and finish</button>
      <p class="error-msg hidden" id="err-zoom"></p>
    </div>

    <div class="step hidden" id="step-done">
      <h2>All set!</h2>
      <p>Setup is complete. The device will restart and your dog can start calling you.</p>
      <div class="done-msg hidden" id="done-msg">Restarting in a few seconds‚Ä¶</div>
    </div>

    <div class="step" style="margin-top:24px;">
      <h2>Update</h2>
      <p>Get the latest version from <a href="https://github.com/TimothyFsr/Dogphone" target="_blank" rel="noopener">GitHub</a>. If this device was installed from git, you can update now.</p>
      <button type="button" id="btn-update" class="secondary">Check for updates</button>
      <p class="error-msg hidden" id="err-update"></p>
      <p class="done-msg hidden" id="msg-update"></p>
    </div>
  </div>

  <script>
    const API = '';
    const qrEl = document.getElementById('qrcode');
    const urlEl = document.getElementById('setup-url');
    const urlAltEl = document.getElementById('setup-url-alt');
    const stepScan = document.getElementById('step-scan');
    const stepWifi = document.getElementById('step-wifi');
    const stepTelegram = document.getElementById('step-telegram');
    const stepMessage = document.getElementById('step-message');
    const stepZoom = document.getElementById('step-zoom');
    const stepDone = document.getElementById('step-done');
    const tokenInput = document.getElementById('token');
    const btnToken = document.getElementById('btn-token');
    const btnDetect = document.getElementById('btn-detect');
    const errToken = document.getElementById('err-token');
    const errDetect = document.getElementById('err-detect');
    const doneMsg = document.getElementById('done-msg');
    const chatIdManualInput = document.getElementById('chat-id-manual');
    const btnManualChat = document.getElementById('btn-manual-chat');
    const btnUpdate = document.getElementById('btn-update');
    const errUpdate = document.getElementById('err-update');
    const msgUpdate = document.getElementById('msg-update');
    const btnWifi = document.getElementById('btn-wifi');
    const errWifi = document.getElementById('err-wifi');
    const msgWifiReboot = document.getElementById('msg-wifi-reboot');
    const btnZoom = document.getElementById('btn-zoom');
    const errZoom = document.getElementById('err-zoom');

    async function api(path, opts = {}) {
      const base = location.origin;
      const r = await fetch(base + path, { headers: { 'Content-Type': 'application/json' }, ...opts });
      return r.json();
    }

    async function loadStatus() {
      const s = await api('/api/status');
      const url = s.setup_url || (location.protocol + '//' + location.host);
      urlEl.innerHTML = '<a href="' + url + '">' + url + '</a>';
      if (s.alternate_urls && s.alternate_urls.length) {
        urlAltEl.innerHTML = s.alternate_urls.map(u => '<a href="' + u + '">' + u + '</a>').join(' &nbsp; ');
        urlAltEl.style.display = 'block';
      } else {
        urlAltEl.style.display = 'none';
      }
      if (typeof QRCode !== 'undefined' && qrEl) {
        qrEl.innerHTML = '';
        var canvas = document.createElement('canvas');
        qrEl.appendChild(canvas);
        QRCode.toCanvas(canvas, url, { width: 220, margin: 1 }, function(err) {
          if (err) { qrEl.innerHTML = '<p class="error-msg">QR failed. Use the URL below.</p>'; }
        });
      }
      stepWifi.classList.add('hidden');
      stepTelegram.classList.add('hidden');
      stepMessage.classList.add('hidden');
      stepZoom.classList.add('hidden');
      stepDone.classList.add('hidden');
      if (s.ready) {
        stepScan.classList.add('hidden');
        stepDone.classList.remove('hidden');
        doneMsg.classList.remove('hidden');
        return s;
      }
      if (!s.has_internet) {
        stepScan.classList.remove('hidden');
        stepWifi.classList.remove('hidden');
        return s;
      }
      // Pi has internet: show scan (QR) + all sign-in steps (Telegram, Chat ID, Zoom) so they're always visible
      stepScan.classList.remove('hidden');
      stepTelegram.classList.remove('hidden');
      stepMessage.classList.remove('hidden');
      stepZoom.classList.remove('hidden');
      // Disable only Chat ID step when already set (token and Zoom can always be edited)
      if (s.chat_id) {
        var msgBtn = stepMessage.querySelector('#btn-detect');
        var msgInput = stepMessage.querySelector('#chat-id-manual');
        if (msgBtn) msgBtn.disabled = true;
        if (msgInput) msgInput.disabled = true;
      }
      return s;
    }

    btnWifi.addEventListener('click', async () => {
      errWifi.classList.add('hidden');
      msgWifiReboot.classList.add('hidden');
      const ssid = (document.getElementById('wifi-ssid').value || '').trim();
      const password = (document.getElementById('wifi-password').value || '');
      if (!ssid) { errWifi.textContent = 'Enter your WiFi name.'; errWifi.classList.remove('hidden'); return; }
      btnWifi.disabled = true;
      try {
        const r = await api('/api/wifi', { method: 'POST', body: JSON.stringify({ ssid, password }) });
        if (r.ok && r.reboot) {
          msgWifiReboot.classList.remove('hidden');
          errWifi.classList.add('hidden');
        } else {
          errWifi.textContent = r.error || 'Connection failed. Try again.';
          errWifi.classList.remove('hidden');
        }
      } catch (e) {
        errWifi.textContent = 'Network error. Are you on DogPhone-Setup WiFi?';
        errWifi.classList.remove('hidden');
      }
      btnWifi.disabled = false;
    });

    btnZoom.addEventListener('click', async () => {
      errZoom.classList.add('hidden');
      const videoUrl = (document.getElementById('video-url').value || '').trim();
      const videoPassword = (document.getElementById('video-password').value || '').trim();
      if (!videoUrl) { errZoom.textContent = 'Enter your Zoom Meeting ID or Join URL.'; errZoom.classList.remove('hidden'); return; }
      btnZoom.disabled = true;
      try {
        const r = await api('/api/video_url', { method: 'POST', body: JSON.stringify({ video_call_url: videoUrl, video_call_password: videoPassword }) });
        if (r.ok) {
          stepZoom.classList.add('hidden');
          stepDone.classList.remove('hidden');
          doneMsg.classList.remove('hidden');
          setTimeout(() => api('/api/complete', { method: 'POST', body: JSON.stringify({}) }), 500);
        } else {
          errZoom.textContent = r.error || 'Failed to save.';
          errZoom.classList.remove('hidden');
        }
      } catch (e) {
        errZoom.textContent = 'Network error.';
        errZoom.classList.remove('hidden');
      }
      btnZoom.disabled = false;
    });

    btnToken.addEventListener('click', async () => {
      errToken.classList.add('hidden');
      const token = tokenInput.value.trim();
      if (!token) { errToken.textContent = 'Please paste your bot token.'; errToken.classList.remove('hidden'); return; }
      btnToken.disabled = true;
      try {
        const r = await api('/api/telegram', { method: 'POST', body: JSON.stringify({ token }) });
        if (r.ok) {
          stepTelegram.classList.add('hidden');
          stepMessage.classList.remove('hidden');
        } else { errToken.textContent = r.error || 'Failed'; errToken.classList.remove('hidden'); }
      } catch (e) {
        errToken.textContent = 'Network error. Are you on DogPhone-Setup WiFi?'; errToken.classList.remove('hidden');
      }
      btnToken.disabled = false;
    });

    btnDetect.addEventListener('click', async () => {
      errDetect.classList.add('hidden');
      btnDetect.disabled = true;
      btnDetect.textContent = 'Checking‚Ä¶';
      try {
        const r = await api('/api/chat_id');
        if (r.ok && r.chat_id) {
          stepMessage.classList.add('hidden');
          stepZoom.classList.remove('hidden');
        } else {
          if (r.error === 'network_error') {
            errDetect.textContent = 'Device can‚Äôt reach Telegram (no internet on hotspot). Use ‚ÄúOr paste your Chat ID‚Äù below.';
          } else if (r.error === 'no_updates') {
            errDetect.textContent = 'No message yet. Send a message to your bot in Telegram, then try again.';
          } else if (r.error === 'invalid_token') {
            errDetect.textContent = 'Invalid bot token. Check step 2 and save the token again.';
          } else {
            errDetect.textContent = 'Could not detect. Send a message to your bot, or enter your Chat ID below.';
          }
          errDetect.classList.remove('hidden');
        }
      } catch (e) {
        errDetect.textContent = 'Network error. Use ‚ÄúOr paste your Chat ID‚Äù below.';
        errDetect.classList.remove('hidden');
      }
      btnDetect.disabled = false;
      btnDetect.textContent = 'I sent a message ‚Äì detect me';
    });

    btnManualChat.addEventListener('click', async () => {
      const cid = (chatIdManualInput.value || '').trim().replace(/\s/g, '');
      if (!cid || !/^-?\d+$/.test(cid)) {
        errDetect.textContent = 'Enter a number (your Chat ID from @userinfobot).';
        errDetect.classList.remove('hidden');
        return;
      }
      errDetect.classList.add('hidden');
      btnManualChat.disabled = true;
      try {
        const r = await api('/api/chat_id', { method: 'POST', body: JSON.stringify({ chat_id: cid }) });
        if (r.ok) {
          stepMessage.classList.add('hidden');
          stepZoom.classList.remove('hidden');
        } else {
          errDetect.textContent = 'Failed to save. Try again.';
          errDetect.classList.remove('hidden');
        }
      } catch (e) {
        errDetect.textContent = 'Network error.';
        errDetect.classList.remove('hidden');
      }
      btnManualChat.disabled = false;
    });

    btnUpdate.addEventListener('click', async () => {
      errUpdate.classList.add('hidden');
      msgUpdate.classList.add('hidden');
      btnUpdate.disabled = true;
      try {
        const r = await api('/api/update', { method: 'POST' });
        if (r.ok) {
          msgUpdate.textContent = r.message || 'Done. Restart the device to apply changes.';
          msgUpdate.classList.remove('hidden');
        } else {
          errUpdate.textContent = r.message || 'Update failed.';
          errUpdate.classList.remove('hidden');
        }
      } catch (e) {
        errUpdate.textContent = 'Network error.';
        errUpdate.classList.remove('hidden');
      }
      btnUpdate.disabled = false;
    });

    loadStatus().catch(function() {
      // If status fails (e.g. wrong network), still show sign-in steps so user can try
      stepWifi.classList.add('hidden');
      stepScan.classList.remove('hidden');
      stepTelegram.classList.remove('hidden');
      stepMessage.classList.remove('hidden');
      stepZoom.classList.remove('hidden');
      stepDone.classList.add('hidden');
      var notice = document.createElement('p');
      notice.className = 'error-msg';
      notice.textContent = 'Could not reach the device. If you\'re on the same WiFi as the Pi, refresh the page. You can still try the steps below.';
      stepScan.appendChild(notice);
    });
  </script>
</body>
</html>
