<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DogPhone Setup</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      padding: 24px;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      line-height: 1.5;
    }
    .container { max-width: 420px; margin: 0 auto; }
    h1 {
      font-size: 1.75rem;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sub { color: #888; margin-bottom: 24px; font-size: 0.95rem; }
    .step {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .step h2 { margin: 0 0 8px; font-size: 1.1rem; }
    .step p { margin: 0 0 12px; color: #bbb; font-size: 0.9rem; }
    #qrcode {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      display: inline-block;
      margin: 12px 0;
    }
    #qrcode canvas, #qrcode img { display: block; }
    .url-box {
      background: #0f0f1a;
      padding: 10px 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.85rem;
      word-break: break-all;
      margin: 8px 0;
    }
    .url-box a { color: #7dd3fc; }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0f0f1a;
      color: #eee;
      font-size: 1rem;
      margin-bottom: 12px;
    }
    input::placeholder { color: #666; }
    button {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #e879f9;
      color: #1a1a2e;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    button.secondary { background: #334155; color: #e2e8f0; }
    .done-msg {
      background: #14532d;
      color: #86efac;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-weight: 500;
    }
    .error-msg { color: #f87171; font-size: 0.9rem; margin-top: 8px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üêï DogPhone</h1>
    <p class="sub">Set up in a few steps</p>

    <!-- Step 0: On-screen instructions (for the Pi display) -->
    <div class="step" id="step-scan">
      <h2>1. Open setup on your phone</h2>
      <p>Connect your phone to WiFi <strong>DogPhone-Setup</strong> (password on the box or sticker).</p>
      <p>Then <strong>scan this QR code</strong> with your camera to open the setup page:</p>
      <div id="qrcode"></div>
      <p>Or open this address in your browser:</p>
      <div class="url-box" id="setup-url"></div>
    </div>

    <!-- Steps shown when opened on phone -->
    <div class="step" id="step-telegram">
      <h2>2. Connect Telegram</h2>
      <p>Create a bot in Telegram: open <strong>@BotFather</strong>, send <code>/newbot</code>, follow the steps, then copy the <strong>bot token</strong> here.</p>
      <input type="text" id="token" placeholder="Paste your bot token" autocomplete="off">
      <button type="button" id="btn-token">Save token</button>
      <p class="error-msg hidden" id="err-token"></p>
    </div>

    <div class="step hidden" id="step-message">
      <h2>3. Send a message to your bot</h2>
      <p>In Telegram, open a chat with your new bot and send any message (e.g. <strong>hi</strong>).</p>
      <button type="button" id="btn-detect">I sent a message ‚Äì detect me</button>
      <p class="error-msg hidden" id="err-detect"></p>
    </div>

    <div class="step hidden" id="step-done">
      <h2>4. All set!</h2>
      <p>Setup is complete. The device will restart and your dog can start calling you.</p>
      <div class="done-msg hidden" id="done-msg">Restarting in a few seconds‚Ä¶</div>
    </div>
  </div>

  <script>
    const API = '';
    const qrEl = document.getElementById('qrcode');
    const urlEl = document.getElementById('setup-url');
    const stepScan = document.getElementById('step-scan');
    const stepTelegram = document.getElementById('step-telegram');
    const stepMessage = document.getElementById('step-message');
    const stepDone = document.getElementById('step-done');
    const tokenInput = document.getElementById('token');
    const btnToken = document.getElementById('btn-token');
    const btnDetect = document.getElementById('btn-detect');
    const errToken = document.getElementById('err-token');
    const errDetect = document.getElementById('err-detect');
    const doneMsg = document.getElementById('done-msg');

    async function api(path, opts = {}) {
      const base = location.origin;
      const r = await fetch(base + path, { headers: { 'Content-Type': 'application/json' }, ...opts });
      return r.json();
    }

    async function loadStatus() {
      const s = await api('/api/status');
      const url = s.setup_url || (location.protocol + '//' + location.host);
      urlEl.innerHTML = '<a href="' + url + '">' + url + '</a>';
      if (typeof QRCode !== 'undefined') {
        QRCode.toCanvas(url, { width: 220, margin: 1 }, (err, canvas) => {
          if (!err && canvas) qrEl.appendChild(canvas);
        });
      }
      if (s.ready) {
        stepScan.classList.add('hidden');
        stepTelegram.classList.add('hidden');
        stepMessage.classList.add('hidden');
        stepDone.classList.remove('hidden');
        doneMsg.classList.remove('hidden');
        return;
      }
      if (s.has_token) {
        stepTelegram.classList.add('hidden');
        stepMessage.classList.remove('hidden');
      }
      return s;
    }

    btnToken.addEventListener('click', async () => {
      errToken.classList.add('hidden');
      const token = tokenInput.value.trim();
      if (!token) { errToken.textContent = 'Please paste your bot token.'; errToken.classList.remove('hidden'); return; }
      btnToken.disabled = true;
      try {
        const r = await api('/api/telegram', { method: 'POST', body: JSON.stringify({ token }) });
        if (r.ok) {
          stepTelegram.classList.add('hidden');
          stepMessage.classList.remove('hidden');
        } else { errToken.textContent = r.error || 'Failed'; errToken.classList.remove('hidden'); }
      } catch (e) {
        errToken.textContent = 'Network error. Are you on DogPhone-Setup WiFi?'; errToken.classList.remove('hidden');
      }
      btnToken.disabled = false;
    });

    btnDetect.addEventListener('click', async () => {
      errDetect.classList.add('hidden');
      btnDetect.disabled = true;
      btnDetect.textContent = 'Checking‚Ä¶';
      try {
        const r = await api('/api/chat_id');
        if (r.ok && r.chat_id) {
          stepMessage.classList.add('hidden');
          stepDone.classList.remove('hidden');
          doneMsg.classList.remove('hidden');
          setTimeout(() => api('/api/complete', { method: 'POST', body: JSON.stringify({ chat_id: r.chat_id }) }), 500);
        } else {
          errDetect.textContent = 'No message yet. Send a message to your bot in Telegram, then try again.';
          errDetect.classList.remove('hidden');
        }
      } catch (e) {
        errDetect.textContent = 'Network error.'; errDetect.classList.remove('hidden');
      }
      btnDetect.disabled = false;
      btnDetect.textContent = 'I sent a message ‚Äì detect me';
    });

    loadStatus();
  </script>
</body>
</html>
